syntax = "proto3";

// Then the compiler also creates a separate .java file for each top-level message,
// enumeration, and service declared in the .proto file.
option java_multiple_files = true;
option java_package = "cl.ucn.fondef.sata.mini.grpc";

// Estas son las peticiones que se enviarán desde "Backend Application"
// hasta el "Central Core" para que pueda manejar la base de datos
service WebCoreCommuService {
  // el atributo JsonWebToken del objeto ObjetoSesion debe ser "" si el inicio de sesion falla
  rpc loginUsuario(Credenciales) returns (ObjetoSesion){}

  // Usuario Administrador
  rpc agregarUsuario(UsuarioNuevo) returns (MensajeResultadoOperacion) {}
  rpc getUsuario(Rut) returns (Usuario) {}
  rpc setUsuario(Usuario) returns (MensajeResultadoOperacion) {}
  rpc getUsuarios(Empty) returns (ListaUsuarios) {}

  // INHABILITAR USUARIO/SIMULADOR es sólo editar 1 atributo
  // podriamos simplemente usar la función setUsuario/setSimulador

  // Usuario Configurador y Operador
  // agregarSimulador y setSimulador tienen la keyword "stream" para enviar las fotos como stream
  rpc crearSimulador(stream Simulador) returns (MensajeResultadoOperacion){}
  rpc getSimuladores(Empty) returns (ListaSimuladoresAcotado) {}
  rpc getSimulador(IdElemento) returns (Simulador) {}
  rpc setSimulador(stream Simulador) returns (MensajeResultadoOperacion){}

  rpc getSimulaciones(Empty) returns (ListaSimulacionesAcotada){}
  rpc getSimulacionEspecifica(IdElemento) returns (SimulacionEspecifica){}

  // el cliente nuxt enviará la petición de inicio y la recibirá el "Backend App". Luego,
  // este ejecutará la función de abajo para enviarle al "Central Core" los "ParametrosSimulacion".
  // El "Central Core", como server, recibirá los valores para redirigirlos ejecutando (1).
  rpc sendValoresInicioSimulacion(ParametrosInicioSimulacion) returns (MensajeResultadoOperacion){}
  // "Central Core" desde (1) recibirá un String de respuesta que luego se enviará a "Backend App"

  // esta funcion busca preguntarle al Raspberry qué simulador y simulación está corriendo
  // va de la mano con la funcion (2)      OJO  bool simulacionIniciada
  rpc getSimulacionEjecutandose(Empty) returns (SimulacionEjecutandose){}
  // si no hay simulacion iniciada, los valores string deben ser "" y el atributo
  // simulacionIniciada = false

  // esta funcion va de la mano con (3) y busca obtener los valores obtenidos de los sensores
  // como un "stream" => iremos obteniendo los valores a través del tiempo
  // BUSCAR WEB SOCKETS y CÓMO CANCELAR UN STREAM SI EL CLIENTE CAMBIA DE PÁGINA
  rpc getLecturasSimulador(Empty) returns (stream LecturaSensores) {}
}


// Estas son las peticiones que se enviarán desde "Central Core"
// hasta el Componente Raspi para manejar el hardware
service CoreRaspiCommuService {
  // (1)                       acá generamos la id de la simulacion si es que todo sale bien
  rpc startSimulacion(ParametrosInicioSimulacion) returns (ResultadoInicioSimulacion){}

  // (2) preguntarle al raspi qué simulador y qué secuencia se usaron  => OJO bool simulacion_ejecutandose
  rpc getSimulacionEjecutandose(Empty) returns (SimulacionEjecutandose){}

  // (3) obtener valores de los sensores
  rpc getLecturasSimulador(Empty) returns (stream LecturaSensores) {}
}

// se usa esto para las funciones que usan 0 argumentos
message Empty {}

message IdElemento {
  int32 id = 1;
}

message Credenciales {
  string correo = 1;
  string contrasena = 2;
}

message ObjetoSesion {
  bool sesion_iniciada = 1;
  string Json_Web_Token = 2;
}

message MensajeResultadoOperacion {
  string mensaje_texto = 1;
}

message Usuario {
  string nombre = 1;
  string apellido = 2;
  string rut = 3;
  string correo = 4;
  string contrasena = 5;
  string rol = 6;
  bool estado = 7;
}

message UsuarioNuevo {
  string rut_administrador = 1;
  Usuario usuario_nuevo = 2;
}

message Rut {
  string rut = 1;
}

message ListaUsuarios {
  repeated Usuario usuario = 1;
}

message CompFisico {
  int32 id = 1;
  string descripcion = 2;
  int32 pin = 3;
  bool estado = 4;
}

// la palabra "repeated" quiere decir que aceptaremos una lista de eso
message Simulador {
  string nombre = 1;
  string descripcion = 2;
  string enlace_repo = 3;
  repeated bytes imagen = 4;
  repeated CompFisico valvulas = 5;
  repeated CompFisico sensores = 6;
  repeated CompFisico camaras = 7;
  bool estado = 8;
  string rut_configurador = 9;
}

// esto corresponde a una fila de la tabla display simuladores
// tambien sirve para las listas desplegables
message SimuladorAcotado {
  int32 id = 1;
  string nombre = 2;
  bool estado = 3;
}

message ListaSimuladoresAcotado {
  repeated SimuladorAcotado simuladorAcotado = 1;
}

// esto corresponde a una fila de la tabla display simulaciones
// tambien sirve para las listas desplegables
message SimulacionAcotada {
  int32 id_simulacion = 1;
  string nombre_simulador = 2;
  string fecha_simulacion = 3;
  int32 agua_caida = 4;
}

message ListaSimulacionesAcotada {
  repeated SimulacionAcotada listaSimulacionesAcotada = 1;
}

// cada Evento es una fila de la tabla generador de eventos
message Evento {
  int32 intensidad = 1;
  int32 duracion = 2;
}

// una secuencia es el conjunto de eventos en una válvula
// una secuencia es cada tabla de eventos
message Secuencia {
  int32 id_simulador = 1;
  string nombre = 2;
  repeated Evento lista_eventos = 3;
}

message SimulacionEspecifica {
  int32 id_simulacion = 1;
  string fecha_simulacion = 2;
  string nombre_simulador = 3;
  string descripcion_simulador = 4;
  repeated Secuencia secuencia_valvula = 5;
  int32 agua_caida = 6;
}

message ParametrosInicioSimulacion {
  int32 id_simulador = 1;
  string rut_operador = 2;
  string nombre_simulacion = 3;
  string descripcion_simulacion = 4;
  repeated Secuencia secuencia_valvula = 5;
}

message ResultadoInicioSimulacion {
  bool inicio_exitoso = 1;
  string mensaje_resultado = 2;
  string fecha = 3;
}

message SimulacionEjecutandose {
  bool simulacion_ejecutandose = 1;
  int32 id_simulacion = 2;
  int32 id_simulador = 3;
}

message LecturaSensores {
  int32 id_simulador = 1;
  int32 flujo_medido = 2;
  float tiempo_transcurrido = 3;
}